#!/usr/bin/env bash
set -euo pipefail

# Declarative package installation for CachyOS
# Automatically installs packages defined in .chezmoidata/packages.yaml
# Only runs when the package list changes (tracked by hash comment)

# Hash of package list for change detection
# packages: {{ .packages.cachyos.pacman | toJson | sha256sum }}

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“¦ Installing system packages for CachyOS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Track what needs installation
PACKAGES_TO_INSTALL=()

{{ range .packages.cachyos.pacman -}}
# Check if {{ . }} is installed
if ! pacman -Qi "{{ . }}" &>/dev/null; then
    PACKAGES_TO_INSTALL+=("{{ . }}")
    echo "ğŸ“‹ Will install: {{ . }}"
else
    echo "âœ“ Already installed: {{ . }}"
fi
{{ end }}

# Install packages if needed
if [ ${#PACKAGES_TO_INSTALL[@]} -gt 0 ]; then
    echo ""
    echo "Installing ${#PACKAGES_TO_INSTALL[@]} package(s)..."
    sudo pacman -S --noconfirm "${PACKAGES_TO_INSTALL[@]}"
    echo "âœ“ All packages installed successfully"
else
    echo "âœ“ All packages already installed"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… Package installation complete"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ’¡ To add more packages:"
echo "   1. Edit: ~/.local/share/chezmoi/home/.chezmoidata/packages.yaml"
echo "   2. Run:  chezmoi apply"