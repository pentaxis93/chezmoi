# Ultra-Zen Password Retrieval
# "Secrets flow from intention to clipboard"

function bw-copy --description "Copy password to clipboard with fuzzy search"
    # Ensure vault is unlocked
    bw-unlock
    or return 1

    # Get all items
    set -l items (bw list items --raw 2>/dev/null)
    if test -z "$items"
        echo "{{ template "color-hex.tmpl" .kanagawa.dragon.red }}✗{{ template "color-hex.tmpl" .kanagawa.dragon.white }} No items found in vault"
        return 1
    end

    # Parse items for selection using fzf
    set -l selected (echo $items | \
        jq -r '.[] | select(.login.password != null) | "\(.name) | \(.login.username // "no username") | \(.id)"' | \
        fzf --prompt="Select password: " \
            --height=20 \
            --layout=reverse \
            --border \
            --preview-window=hidden)

    if test -z "$selected"
        echo "{{ template "color-hex.tmpl" .kanagawa.dragon.bright_black }}○{{ template "color-hex.tmpl" .kanagawa.dragon.white }} No selection made"
        return 1
    end

    # Extract item ID
    set -l item_id (echo $selected | awk -F' | ' '{print $NF}')

    # Get password and copy to clipboard
    set -l password (bw get password $item_id 2>/dev/null)
    if test -n "$password"
        # Use wl-copy for Wayland clipboard
        if type -q wl-copy
            echo -n $password | wl-copy
        else
            echo "{{ template "color-hex.tmpl" .kanagawa.dragon.red }}✗{{ template "color-hex.tmpl" .kanagawa.dragon.white }} No clipboard manager found (install wl-clipboard)"
            return 1
        end

        # Extract name for feedback
        set -l item_name (echo $selected | awk -F' | ' '{print $1}')
        echo "{{ template "color-hex.tmpl" .kanagawa.dragon.green }}✓{{ template "color-hex.tmpl" .kanagawa.dragon.white }} Password for '$item_name' copied to clipboard"
    else
        echo "{{ template "color-hex.tmpl" .kanagawa.dragon.red }}✗{{ template "color-hex.tmpl" .kanagawa.dragon.white }} Failed to retrieve password"
        return 1
    end
end