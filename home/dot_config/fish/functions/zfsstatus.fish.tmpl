# Ultra-Zen ZFS Pool Health Check
# "The mirror reflects truth; the checksum reveals integrity"

function zfsstatus --description "Show ZFS pool health and recent scrub status"
    echo "{{ template "color-hex.tmpl" .themes.kanagawa.dragon.blue }}╭─────────────────────────────────────────────╮{{ template "color-hex.tmpl" .themes.kanagawa.dragon.white }}"
    echo "{{ template "color-hex.tmpl" .themes.kanagawa.dragon.blue }}│{{ template "color-hex.tmpl" .themes.kanagawa.dragon.white }} ZFS Pool Health Status                      {{ template "color-hex.tmpl" .themes.kanagawa.dragon.blue }}│{{ template "color-hex.tmpl" .themes.kanagawa.dragon.white }}"
    echo "{{ template "color-hex.tmpl" .themes.kanagawa.dragon.blue }}╰─────────────────────────────────────────────╯{{ template "color-hex.tmpl" .themes.kanagawa.dragon.white }}"
    echo

    # Pool status
    echo "{{ template "color-hex.tmpl" .themes.kanagawa.dragon.blue }}═══ Pool Status ═══{{ template "color-hex.tmpl" .themes.kanagawa.dragon.white }}"
    zpool status
    echo

    # Pool capacity and health summary
    echo "{{ template "color-hex.tmpl" .themes.kanagawa.dragon.blue }}═══ Pool Summary ═══{{ template "color-hex.tmpl" .themes.kanagawa.dragon.white }}"
    zpool list
    echo

    # Recent snapshots count
    set -l snap_count (zfs list -t snapshot -o name -H | wc -l)
    echo "{{ template "color-hex.tmpl" .themes.kanagawa.dragon.blue }}═══ Snapshot Timeline ═══{{ template "color-hex.tmpl" .themes.kanagawa.dragon.white }}"
    echo "{{ template "color-hex.tmpl" .themes.kanagawa.dragon.green }}✓{{ template "color-hex.tmpl" .themes.kanagawa.dragon.white }} Total snapshots: $snap_count"

    # Show most recent snapshots
    echo
    echo "{{ template "color-hex.tmpl" .themes.kanagawa.dragon.bright_black }}Recent snapshots (last 5):{{ template "color-hex.tmpl" .themes.kanagawa.dragon.white }}"
    zfs list -t snapshot -o name,used,creation -s creation -H | tail -5
    echo

    # Scrub status
    echo "{{ template "color-hex.tmpl" .themes.kanagawa.dragon.blue }}═══ Scrub Status ═══{{ template "color-hex.tmpl" .themes.kanagawa.dragon.white }}"
    set -l scrub_status (zpool status | grep -A 2 "scan:")
    if test -n "$scrub_status"
        echo $scrub_status
    else
        echo "{{ template "color-hex.tmpl" .themes.kanagawa.dragon.bright_black }}No scrub has been run{{ template "color-hex.tmpl" .themes.kanagawa.dragon.white }}"
    end
    echo
end
