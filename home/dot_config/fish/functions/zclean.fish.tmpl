# Ultra-Zen ZFS Snapshot Cleanup
# "Let go of distant echoes; preserve the recent song"

function zclean --description "Clean old automatic snapshots (interactive)"
    set -l days $argv[1]

    if test -z "$days"
        set days 90  # Default: keep 90 days
    end

    echo "{{ template "color-hex.tmpl" .themes.kanagawa.dragon.blue }}═══ Finding automatic snapshots older than $days days ═══{{ template "color-hex.tmpl" .themes.kanagawa.dragon.white }}"
    echo

    # Calculate cutoff date (days ago)
    set -l cutoff_date (date -d "$days days ago" +%s)

    # Find old auto-snapshots
    set -l old_snapshots
    for snap in (zfs list -t snapshot -o name,creation -H | grep '@auto-')
        set -l snap_name (echo $snap | awk '{print $1}')
        set -l snap_date_str (echo $snap | cut -f2- -d' ' | string trim)

        # Convert snapshot creation date to epoch
        set -l snap_date (date -d "$snap_date_str" +%s 2>/dev/null)

        # Compare dates
        if test -n "$snap_date" -a "$snap_date" -lt "$cutoff_date"
            set -a old_snapshots $snap_name
        end
    end

    # Check if any snapshots found
    if test (count $old_snapshots) -eq 0
        echo "{{ template "color-hex.tmpl" .themes.kanagawa.dragon.green }}✓{{ template "color-hex.tmpl" .themes.kanagawa.dragon.white }} No old automatic snapshots to clean"
        return 0
    end

    # Show what would be deleted
    echo "{{ template "color-hex.tmpl" .themes.kanagawa.dragon.yellow }}The following snapshots will be DESTROYED:{{ template "color-hex.tmpl" .themes.kanagawa.dragon.white }}"
    echo
    for snap in $old_snapshots
        # Get space used by this snapshot
        set -l used (zfs list -t snapshot -o used -H $snap)
        echo "  {{ template "color-hex.tmpl" .themes.kanagawa.dragon.red }}•{{ template "color-hex.tmpl" .themes.kanagawa.dragon.white }} $snap {{ template "color-hex.tmpl" .themes.kanagawa.dragon.bright_black }}($used){{ template "color-hex.tmpl" .themes.kanagawa.dragon.white }}"
    end
    echo
    echo "{{ template "color-hex.tmpl" .themes.kanagawa.dragon.bright_black }}This will free the space they occupy (changes since snapshot){{ template "color-hex.tmpl" .themes.kanagawa.dragon.white }}"
    echo

    # Interactive confirmation
    read -P "{{ template "color-hex.tmpl" .themes.kanagawa.dragon.yellow }}Type 'yes' to destroy these snapshots: {{ template "color-hex.tmpl" .themes.kanagawa.dragon.white }}" confirm

    if test "$confirm" = "yes"
        echo
        for snap in $old_snapshots
            echo "{{ template "color-hex.tmpl" .themes.kanagawa.dragon.blue }}Destroying:{{ template "color-hex.tmpl" .themes.kanagawa.dragon.white }} $snap"
            zfs destroy $snap
        end
        echo
        echo "{{ template "color-hex.tmpl" .themes.kanagawa.dragon.green }}✓{{ template "color-hex.tmpl" .themes.kanagawa.dragon.white }} Cleanup complete"
    else
        echo
        echo "{{ template "color-hex.tmpl" .themes.kanagawa.dragon.bright_black }}○{{ template "color-hex.tmpl" .themes.kanagawa.dragon.white }} Cancelled. No snapshots destroyed."
    end
end
